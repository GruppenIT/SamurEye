# vlxsam02 - Application Server

Servidor de aplica√ß√£o SamurEye com Node.js 20 e aplica√ß√£o completa.

## Scripts Dispon√≠veis

### install-hard-reset.sh
Script completo de reset e reinstala√ß√£o do servidor de aplica√ß√£o.

**O que faz:**
- Remove aplica√ß√£o existente completamente
- Reinstala Node.js 20 sem conflitos
- Baixa aplica√ß√£o SamurEye do GitHub
- Configura ambiente de produ√ß√£o
- Faz build da aplica√ß√£o
- Configura servi√ßo systemd
- Inicia aplica√ß√£o automaticamente

### debug-app.sh
Script de diagn√≥stico para problemas na aplica√ß√£o.

**Uso:**
```bash
./debug-app.sh
```

**O que verifica:**
- Status do servi√ßo systemd
- Logs de erro da aplica√ß√£o
- Logs do sistema
- Conectividade PostgreSQL
- Arquivos e permiss√µes
- Execu√ß√£o manual da aplica√ß√£o

## Arquitetura

```
vlxsam02 (172.24.1.152)
‚îú‚îÄ‚îÄ Node.js 20.x
‚îú‚îÄ‚îÄ SamurEye Application
‚îÇ   ‚îú‚îÄ‚îÄ Frontend (React + Vite)
‚îÇ   ‚îú‚îÄ‚îÄ Backend (Express + TypeScript)
‚îÇ   ‚îî‚îÄ‚îÄ Database (PostgreSQL client)
‚îú‚îÄ‚îÄ systemd Service
‚îî‚îÄ‚îÄ Logs (/var/log/samureye/)
```

## Depend√™ncias

- **vlxsam03**: PostgreSQL deve estar funcionando primeiro
- **vlxsam01**: Gateway para SSL/proxy (opcional)
- **vlxsam04**: Collector agents (opcional)

## Configura√ß√£o

### Ambiente de Produ√ß√£o (.env)
```bash
NODE_ENV=production
DATABASE_URL=postgresql://samureye:SamurEye2024!@172.24.1.153:5432/samureye
PORT=5000
SESSION_SECRET=<auto-generated>
ADMIN_EMAIL=admin@samureye.local
ADMIN_PASSWORD=SamurEye2024!
```

### Servi√ßo systemd
- **Nome**: samureye-app.service
- **Usu√°rio**: samureye
- **Logs**: /var/log/samureye/
- **Auto-restart**: Sim

## Resolu√ß√£o de Problemas

### Aplica√ß√£o n√£o inicia
```bash
# Verificar status
systemctl status samureye-app

# Verificar logs
journalctl -u samureye-app -f

# Diagn√≥stico completo
./debug-app.sh

# Testar manualmente
cd /opt/samureye/SamurEye
sudo -u samureye NODE_ENV=production node dist/index.js
```

### Erro de conex√£o PostgreSQL
```bash
# Testar conex√£o
PGPASSWORD="SamurEye2024!" psql -h 172.24.1.153 -U samureye -d samureye -c "SELECT version();"

# Verificar se vlxsam03 est√° funcionando
ping 172.24.1.153
telnet 172.24.1.153 5432
```

### Problemas de permiss√£o
```bash
# Corrigir permiss√µes
chown -R samureye:samureye /opt/samureye/
chown -R samureye:samureye /var/log/samureye/

# Reiniciar servi√ßo
systemctl daemon-reload
systemctl restart samureye-app
```

## üöÄ Sistema de Jornadas de Seguran√ßa

### Funcionalidades Avan√ßadas

**Agendamento Inteligente:**
- **On-demand**: Execu√ß√£o imediata de jornadas
- **One-shot**: Agendamento para data/hora espec√≠fica  
- **Recurring**: Execu√ß√£o recorrente (di√°ria, semanal, mensal)

**Execu√ß√£o Distribu√≠da:**
- Polling autom√°tico de jobs pelos collectors
- Execu√ß√£o distribu√≠da usando nmap, nuclei, masscan
- Coleta autom√°tica e centralizada de resultados

**API Endpoints:**
- `GET /api/journeys` - Listar jornadas do tenant
- `POST /api/journeys` - Criar nova jornada
- `POST /api/journeys/:id/start` - Iniciar jornada manualmente
- `PUT /api/journeys/:id/schedule` - Atualizar agendamento
- `GET /api/journeys/:id/executions` - Hist√≥rico de execu√ß√µes

**API para Collectors:**
- `GET /collector-api/journeys/pending` - Buscar jobs pendentes
- `POST /collector-api/journeys/results` - Submeter resultados

### Exemplo de Configura√ß√£o

```json
{
  "name": "Network Security Assessment",
  "type": "surface_attack",
  "target": "192.168.1.0/24",
  "scheduleType": "recurring", 
  "scheduleConfig": {
    "pattern": "daily",
    "time": "02:00",
    "timezone": "America/Sao_Paulo"
  },
  "scanTypes": ["nmap", "nuclei"],
  "collectorId": "collector-001"
}
```

## URLs de Acesso

Ap√≥s configura√ß√£o completa com vlxsam01:
- **Aplica√ß√£o**: https://app.samureye.com.br
- **API**: https://api.samureye.com.br
- **Local**: http://172.24.1.152:5000 (desenvolvimento)

## Monitoramento

### Logs
- **Aplica√ß√£o**: /var/log/samureye/app.log
- **Erros**: /var/log/samureye/error.log
- **Sistema**: journalctl -u samureye-app

### Status
```bash
systemctl status samureye-app
curl http://localhost:5000/api/health
```