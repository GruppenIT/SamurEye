root@vlxsam03:~# curl -fsSL https://raw.githubusercontent.com/GruppenIT/SamurEye/refs/heads/main/docs/deployment/vlxsam03/install-hard-reset.sh | bash

ğŸ”¥ SAMUREYE HARD RESET - DATABASE SERVER vlxsam03
===============================================
âš ï¸  ATENÃ‡ÃƒO: Este script irÃ¡:
   â€¢ Parar todos os serviÃ§os do banco de dados
   â€¢ APAGAR TODOS OS DADOS do PostgreSQL, Redis, MinIO
   â€¢ Reconfigurar pg_hba.conf e postgresql.conf
   â€¢ Resetar senhas e configuraÃ§Ãµes
   â€¢ Recriar banco e usuÃ¡rios SamurEye
   â€¢ Reconfigurar firewall e rede

[19:44:16] WARNING: Modo nÃ£o-interativo detectado (curl | bash)
[19:44:16] INFO: Hard reset iniciarÃ¡ automaticamente em 5 segundos...
[19:44:21] ğŸ—‘ï¸ Iniciando hard reset do servidor de banco de dados...
[19:44:21] ğŸ”§ Reparando sistema de pacotes corrompido...
[19:44:21] WARNING: Matando processos apt/dpkg em execuÃ§Ã£o...
[19:44:26] WARNING: Removendo locks do sistema de pacotes...
[19:44:26] Executando reparos do dpkg...
[19:44:26] Tentativa 1: dpkg --configure -a
[19:44:31] Tentativa 1: apt-get -f install
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
The following package was automatically installed and is no longer required:
  libllvm17t64
Use 'apt autoremove' to remove it.
0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
[19:44:37] âœ… dpkg funcionando na tentativa 1
[19:44:37] Aguardando estabilizaÃ§Ã£o do sistema...
[19:44:47] âœ… Reparo inicial do sistema de pacotes concluÃ­do
[19:44:47] ğŸ“¦ Instalando dependÃªncias bÃ¡sicas...
[19:44:47] Tentativa 1 de atualizaÃ§Ã£o do sistema...
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
The following package was automatically installed and is no longer required:
  libllvm17t64
Use 'apt autoremove' to remove it.
0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
Hit:1 http://apt.postgresql.org/pub/repos/apt noble-pgdg InRelease
Hit:2 https://packages.grafana.com/oss/deb stable InRelease
Hit:3 http://archive.ubuntu.com/ubuntu noble InRelease
Hit:4 http://security.ubuntu.com/ubuntu noble-security InRelease
Hit:5 http://archive.ubuntu.com/ubuntu noble-updates InRelease
Hit:6 http://archive.ubuntu.com/ubuntu noble-backports InRelease
Reading package lists... Done
[19:44:56] âœ… Sistema atualizado
[19:44:56] Tentativa 1 de instalaÃ§Ã£o de dependÃªncias...
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
The following package was automatically installed and is no longer required:
  libllvm17t64
Use 'apt autoremove' to remove it.
0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
psmisc is already the newest version (23.7-1build1).
lsof is already the newest version (4.95.0-1build3).
procps is already the newest version (2:4.0.4-4ubuntu3.2).
The following package was automatically installed and is no longer required:
  libllvm17t64
Use 'apt autoremove' to remove it.
0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
[19:45:01] âœ… DependÃªncias bÃ¡sicas instaladas
[19:45:01] â¹ï¸ Parando todos os serviÃ§os...
[19:45:01] âœ… postgresql parado
[19:45:01] ğŸ’¾ Criando backup dos dados atuais...
[19:45:01] âœ… Backup PostgreSQL criado
[19:45:01] ğŸ“‚ Backup salvo em: /opt/backups/samureye-reset-20250901-194501
[19:45:01] ğŸ—‘ï¸ Removendo dados existentes...
[19:45:01] âœ… Dados PostgreSQL removidos
[19:45:01] âœ… Dados Redis removidos
[19:45:01] âœ… Dados MinIO removidos
[19:45:01] âœ… Dados Grafana removidos
[19:45:01] ğŸ“¦ Instalando dependÃªncias adicionais...
[19:45:01] Tentativa 1 de instalaÃ§Ã£o de dependÃªncias adicionais...
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
The following package was automatically installed and is no longer required:
  libllvm17t64
Use 'apt autoremove' to remove it.
0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
wget is already the newest version (1.21.4-1ubuntu4.1).
curl is already the newest version (8.5.0-2ubuntu10.6).
gnupg2 is already the newest version (2.4.4-2ubuntu17.3).
software-properties-common is already the newest version (0.99.49.3).
apt-transport-https is already the newest version (2.8.3).
ca-certificates is already the newest version (20240203).
The following package was automatically installed and is no longer required:
  libllvm17t64
Use 'apt autoremove' to remove it.
0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
[19:45:06] âœ… DependÃªncias adicionais instaladas
[19:45:06] ğŸ˜ Configurando PostgreSQL 16...
[19:45:06] ğŸ“ Recriando cluster PostgreSQL...
The files belonging to this database system will be owned by user "postgres".
This user must also own the server process.

The database cluster will be initialized with locale "en_US.UTF-8".
The default database encoding has accordingly been set to "UTF8".
The default text search configuration will be set to "english".

Data page checksums are disabled.

fixing permissions on existing directory /var/lib/postgresql/16/main ... ok
creating subdirectories ... ok
selecting dynamic shared memory implementation ... posix
selecting default max_connections ... 100
selecting default shared_buffers ... 128MB
selecting default time zone ... Etc/UTC
creating configuration files ... ok
running bootstrap script ... ok
performing post-bootstrap initialization ... ok
syncing data to disk ... ok

initdb: warning: enabling "trust" authentication for local connections
initdb: hint: You can change this by editing pg_hba.conf or using the option -A, or --auth-local and --auth-host, the next time you run initdb.

Success. You can now start the database server using:

    /usr/lib/postgresql/16/bin/pg_ctl -D /var/lib/postgresql/16/main -l logfile start

[19:45:07] âœ… Cluster PostgreSQL recriado
[19:45:07] ğŸš€ Iniciando PostgreSQL...
Synchronizing state of postgresql.service with SysV service script with /usr/lib/systemd/systemd-sysv-install.
Executing: /usr/lib/systemd/systemd-sysv-install enable postgresql
[19:45:13] âœ… PostgreSQL iniciado com sucesso
[19:45:13] âš™ï¸ Configurando postgresql.conf...
[19:45:13] ğŸ” Configurando pg_hba.conf...
[19:45:13] ğŸ”„ Reiniciando PostgreSQL para aplicar configuraÃ§Ãµes...
[19:45:18] âœ… PostgreSQL configurado para SamurEye
[19:45:18] ğŸ‘¤ Criando usuÃ¡rio e banco SamurEye...
Error: Invalid data directory for cluster 16 main
root@vlxsam03:~#