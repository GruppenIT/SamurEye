root@vlxsam04:~# curl -fsSL https://raw.githubusercontent.com/GruppenIT/SamurEye/main/docs/deployment/vlxsam04/fix-token-disconnect.sh | bash
ğŸ› ï¸  CORREÃ‡ÃƒO: SincronizaÃ§Ã£o Token Registro vs ServiÃ§o
====================================================
Data/Hora: Thu Sep  4 09:51:00 AM -03 2025

ğŸ” 1. ANÃLISE INICIAL DO PROBLEMA
--------------------------------
âœ… Arquivo de configuraÃ§Ã£o encontrado
âŒ Token nÃ£o encontrado no arquivo
â„¹ï¸  ServiÃ§o estÃ¡ parado

â¹ï¸ 2. PARANDO SERVIÃ‡O PARA SINCRONIZAÃ‡ÃƒO
----------------------------------------
â„¹ï¸  ServiÃ§o jÃ¡ estava parado

ğŸ”§ 3. VERIFICANDO E CORRIGINDO CONFIGURAÃ‡ÃƒO
------------------------------------------
ğŸ“ Fazendo backup da configuraÃ§Ã£o atual...
ğŸ“ Backup criado: /var/backups/samureye-collector/.env.backup.20250904_095100
ğŸ” Verificando configuraÃ§Ã£o atual...
âŒ Token nÃ£o encontrado na configuraÃ§Ã£o
ğŸ§¹ Limpando configuraÃ§Ã£o invÃ¡lida...
âœ… ConfiguraÃ§Ã£o limpa criada

ğŸ“ 4. LIMPANDO LOGS COM PROBLEMA
-------------------------------
ğŸ“„ Fazendo backup e limpeza do log...
ğŸ“ Backup criado: /var/backups/samureye-collector/collector.log.backup.20250904_095100
âœ… Log limpo e marcado

ğŸ”„ 5. RECARREGANDO CONFIGURAÃ‡ÃƒO DO SYSTEMD
------------------------------------------
ğŸ”„ Recarregando daemon do systemd...
âœ… Daemon recarregado
ğŸ”„ Resetando falhas do serviÃ§o...
âœ… Falhas resetadas

âš™ï¸  6. PREPARANDO SERVIÃ‡O PARA NOVO REGISTRO
-------------------------------------------
â„¹ï¸  ServiÃ§o permanecerÃ¡ parado para novo registro manual
â„¹ï¸  Isso evita conflitos durante o processo de registro
âœ… ServiÃ§o preparado para novo registro

âœ… 7. VERIFICAÃ‡ÃƒO FINAL
----------------------
ğŸ“Š Status final:
   ğŸ”´ ServiÃ§o: activating
inactive
   ğŸ“ Config: presente
   ğŸ“ Log: presente
   ğŸ”’ PermissÃµes config: -rw------- root root

ğŸ¯ CORREÃ‡ÃƒO CONCLUÃDA COM SUCESSO!
=================================

ğŸ“‹ PRÃ“XIMOS PASSOS OBRIGATÃ“RIOS:
  1ï¸âƒ£  O serviÃ§o estÃ¡ parado para evitar conflitos
  2ï¸âƒ£  A configuraÃ§Ã£o foi limpa e preparada
  3ï¸âƒ£  Execute NOVO REGISTRO com o comando completo:

ğŸ”§ COMANDO DE REGISTRO:
curl -fsSL https://raw.githubusercontent.com/GruppenIT/SamurEye/main/docs/deployment/vlxsam04/register-collector.sh | bash -s -- <tenant-slug> <enrollment-token>

ğŸ’¡ IMPORTANTE:
  â¤ Use um NOVO token de enrollment (gere na interface)
  â¤ O token anterior pode ter expirado (15 minutos)
  â¤ O serviÃ§o serÃ¡ iniciado automaticamente apÃ³s registro bem-sucedido

âœ… NÃ£o haverÃ¡ mais conflitos entre registro e serviÃ§o!

ConclusÃ£o: Thu Sep  4 09:51:00 AM -03 2025
root@vlxsam04:~# curl -fsSL https://raw.githubusercontent.com/GruppenIT/SamurEye/main/docs/deployment/vlxsam04/register-collector.sh | bash -s -- gruppen-it 2e07d1c7-f270-49a8-b2fc-7efc28522041

ğŸ”§ REGISTRO COLLECTOR SAMUREYE
==============================

[09:51:34] ğŸ” ParÃ¢metros recebidos:
   â€¢ Tenant Slug: gruppen-it
   â€¢ Token: 2e07d1c7...28522041
[09:51:34] ğŸ” Verificando prerequisitos...
[09:51:35] âœ… Prerequisitos verificados
[09:51:35] ğŸ” Coletando informaÃ§Ãµes do sistema...
[09:51:35]    â€¢ Hostname: vlxsam04
[09:51:35]    â€¢ IP Address: 192.168.100.151
[09:51:35] ğŸŒ Testando conectividade com API...
[09:51:35] âœ… Conectividade OK
[09:51:35] ğŸ”§ Registrando collector...
[09:51:35] ğŸ“¤ Enviando registro para API...
[09:51:35] ğŸ“¥ Processando resposta da API...
[09:51:35] ğŸ‰ COLLECTOR REGISTRADO COM SUCESSO!

[09:51:35] ğŸ“‹ DETALHES DO REGISTRO:
   â€¢ Nome do Collector: vlxsam04
   â€¢ Tenant: Gruppen it
   â€¢ Status: online
   â€¢ Hostname: vlxsam04
   â€¢ IP: 192.168.100.151

[09:51:35] âœ… Collector estÃ¡ online e enviando telemetria

[09:51:35] ğŸ¯ REGISTRO CONCLUÃDO COM SUCESSO!

ğŸ“‹ PRÃ“XIMOS PASSOS:
   â€¢ O collector jÃ¡ estÃ¡ enviando telemetria automaticamente
   â€¢ Verifique o status na interface de administraÃ§Ã£o
   â€¢ O collector aparecerÃ¡ como 'ONLINE' na gestÃ£o de coletores

[09:51:35] âœ… Script de registro finalizado
root@vlxsam04:~# tail -f /var/log/samureye-collector/collector.log
2025-09-04 09:50:59,605 - INFO - Registrando collector: {'name': '', 'hostname': 'vlxsam04', 'ipAddress': '', 'status': 'enrolling', 'description': 'Collector agent on-premise vlxsam04'}
/usr/lib/python3/dist-packages/urllib3/connectionpool.py:1100: InsecureRequestWarning: Unverified HTTPS request is being made to host 'api.samureye.com.br'. Adding certificate verification is strongly advised. See: https://urllib3.readthedocs.io/en/latest/advanced-usage.html#tls-warnings
  warnings.warn(
2025-09-04 09:50:59,652 - ERROR - Erro no registro: 401 - {"message":"Unauthorized"}
2025-09-04 09:50:59,653 - ERROR - Falha no registro inicial
2025-09-04 09:51:00 - INFO - === CORREÃ‡ÃƒO APLICADA: SincronizaÃ§Ã£o Token ===
2025-09-04 09:51:00 - INFO - ConfiguraÃ§Ã£o limpa, pronto para novo registro
2025-09-04 09:51:09,867 - ERROR - Erro ao carregar configuraÃ§Ã£o: [Errno 13] Permission denied: '/etc/samureye-collector/.env'
2025-09-04 09:51:20,108 - ERROR - Erro ao carregar configuraÃ§Ã£o: [Errno 13] Permission denied: '/etc/samureye-collector/.env'
2025-09-04 09:51:30,353 - ERROR - Erro ao carregar configuraÃ§Ã£o: [Errno 13] Permission denied: '/etc/samureye-collector/.env'
2025-09-04 09:51:40,627 - ERROR - Erro ao carregar configuraÃ§Ã£o: [Errno 13] Permission denied: '/etc/samureye-collector/.env'
2025-09-04 09:51:50,868 - ERROR - Erro ao carregar configuraÃ§Ã£o: [Errno 13] Permission denied: '/etc/samureye-collector/.env'
^C
root@vlxsam04:~# curl -fsSL https://raw.githubusercontent.com/GruppenIT/SamurEye/main/docs/deployment/vlxsam04/diagnose-token-disconnect.sh | bash
ğŸ” DIAGNÃ“STICO: DesconexÃ£o Token Registro vs ServiÃ§o
===================================================
Data/Hora: Thu Sep  4 09:52:02 AM -03 2025

ğŸ“Š 1. STATUS DO SERVIÃ‡O COLLECTOR
--------------------------------
âŒ ServiÃ§o samureye-collector estÃ¡ INATIVO

ğŸ“ 2. ANÃLISE DOS ARQUIVOS DE CONFIGURAÃ‡ÃƒO
----------------------------------------
ğŸ” Arquivo principal: /etc/samureye-collector/.env
âœ… Arquivo encontrado
ğŸ“„ ConteÃºdo completo:
    # SamurEye Collector Configuration
    # ConfiguraÃ§Ã£o preparada para novo registro

    # InformaÃ§Ãµes bÃ¡sicas do servidor
    COLLECTOR_ID=vlxsam04
    COLLECTOR_NAME=vlxsam04
    HOSTNAME=vlxsam04
    IP_ADDRESS=192.168.100.151

    # Servidor da API (nÃ£o modificar)
    API_SERVER=https://api.samureye.com.br
    API_PORT=443

    # Token de registro (serÃ¡ preenchido durante registro)
    COLLECTOR_TOKEN=
    ENROLLMENT_TOKEN=

    # Status (serÃ¡ atualizado automaticamente)
    STATUS=offline

    # Logs
    LOG_LEVEL=INFO
    LOG_FILE=/var/log/samureye-collector/collector.log

    # ConfiguraÃ§Ãµes de heartbeat
    HEARTBEAT_INTERVAL=30
    RETRY_INTERVAL=10
    MAX_RETRIES=3

ğŸ”’ PermissÃµes do arquivo:
    -rw------- 1 root root 610 Sep  4 09:51 /etc/samureye-collector/.env

âŒ COLLECTOR_TOKEN estÃ¡ VAZIO
âŒ ENROLLMENT_TOKEN estÃ¡ VAZIO

ğŸ”§ 3. ANÃLISE DO PROCESSO COLLECTOR
----------------------------------
âŒ Nenhum processo collector encontrado

ğŸ“ 4. ANÃLISE DETALHADA DOS LOGS
-------------------------------
âœ… Log encontrado: /var/log/samureye-collector/collector.log
ğŸ“Š EstatÃ­sticas do log:
   ğŸ“ Total de linhas: 108
   ğŸš¨ Erros 401: 13
   ğŸ” Token nÃ£o encontrado: 12
   âœ… Registros bem-sucedidos: 0
0

ğŸ“„ Ãšltimas 15 linhas do log:
    2025-09-04 09:50:59,605 - INFO - Iniciando heartbeat collector...
    2025-09-04 09:50:59,605 - INFO - Token nÃ£o encontrado, registrando collector...
    2025-09-04 09:50:59,605 - INFO - Registrando collector: {'name': '', 'hostname': 'vlxsam04', 'ipAddress': '', 'status': 'enrolling', 'description': 'Collector agent on-premise vlxsam04'}
    /usr/lib/python3/dist-packages/urllib3/connectionpool.py:1100: InsecureRequestWarning: Unverified HTTPS request is being made to host 'api.samureye.com.br'. Adding certificate verification is strongly advised. See: https://urllib3.readthedocs.io/en/latest/advanced-usage.html#tls-warnings
      warnings.warn(
    2025-09-04 09:50:59,652 - ERROR - Erro no registro: 401 - {"message":"Unauthorized"}
    2025-09-04 09:50:59,653 - ERROR - Falha no registro inicial
    2025-09-04 09:51:00 - INFO - === CORREÃ‡ÃƒO APLICADA: SincronizaÃ§Ã£o Token ===
    2025-09-04 09:51:00 - INFO - ConfiguraÃ§Ã£o limpa, pronto para novo registro
    2025-09-04 09:51:09,867 - ERROR - Erro ao carregar configuraÃ§Ã£o: [Errno 13] Permission denied: '/etc/samureye-collector/.env'
    2025-09-04 09:51:20,108 - ERROR - Erro ao carregar configuraÃ§Ã£o: [Errno 13] Permission denied: '/etc/samureye-collector/.env'
    2025-09-04 09:51:30,353 - ERROR - Erro ao carregar configuraÃ§Ã£o: [Errno 13] Permission denied: '/etc/samureye-collector/.env'
    2025-09-04 09:51:40,627 - ERROR - Erro ao carregar configuraÃ§Ã£o: [Errno 13] Permission denied: '/etc/samureye-collector/.env'
    2025-09-04 09:51:50,868 - ERROR - Erro ao carregar configuraÃ§Ã£o: [Errno 13] Permission denied: '/etc/samureye-collector/.env'
    2025-09-04 09:52:01,136 - ERROR - Erro ao carregar configuraÃ§Ã£o: [Errno 13] Permission denied: '/etc/samureye-collector/.env'

ğŸ” PadrÃ£o de tentativas de registro (Ãºltimas 10):
    2025-09-04 09:50:18,108 - INFO - Token nÃ£o encontrado, registrando collector...
    2025-09-04 09:50:18,156 - ERROR - Erro no registro: 401 - {"message":"Unauthorized"}
    2025-09-04 09:50:28,381 - INFO - Token nÃ£o encontrado, registrando collector...
    2025-09-04 09:50:28,431 - ERROR - Erro no registro: 401 - {"message":"Unauthorized"}
    2025-09-04 09:50:38,849 - INFO - Token nÃ£o encontrado, registrando collector...
    2025-09-04 09:50:38,894 - ERROR - Erro no registro: 401 - {"message":"Unauthorized"}
    2025-09-04 09:50:49,131 - INFO - Token nÃ£o encontrado, registrando collector...
    2025-09-04 09:50:49,184 - ERROR - Erro no registro: 401 - {"message":"Unauthorized"}
    2025-09-04 09:50:59,605 - INFO - Token nÃ£o encontrado, registrando collector...
    2025-09-04 09:50:59,652 - ERROR - Erro no registro: 401 - {"message":"Unauthorized"}

ğŸ” 5. BUSCA POR OUTROS ARQUIVOS .env
-----------------------------------
ğŸ” Procurando por arquivos .env relacionados ao collector:
    /etc/samureye-collector/.env

ğŸ” Procurando por arquivos de configuraÃ§Ã£o do SamurEye:
    /etc/rsyslog.d/30-samureye-collector.conf

ğŸŒ 6. TESTE DE CONECTIVIDADE DETALHADO
------------------------------------
ğŸ”— Testando conectividade bÃ¡sica:
âœ… Conectividade bÃ¡sica: OK
ğŸ” Testando endpoint de heartbeat:
ğŸ“Š HTTP Status heartbeat: 404
ğŸ“„ Resposta heartbeat:
    {"message":"Collector not found"}
ğŸ¯ 7. DIAGNÃ“STICO ESPECÃFICO DO PROBLEMA
---------------------------------------
SITUAÃ‡ÃƒO ATUAL:
  âœ… Script register-collector.sh executado com sucesso
  âœ… Registro reportado como bem-sucedido pela API
  âŒ ServiÃ§o collector reporta 'Token nÃ£o encontrado'
  âŒ ServiÃ§o gera erro 401 Unauthorized

POSSÃVEIS CAUSAS:
  1ï¸âƒ£  Token salvo em local diferente do que o serviÃ§o lÃª
  2ï¸âƒ£  PermissÃµes incorretas impedem leitura do token
  3ï¸âƒ£  ServiÃ§o iniciado antes do token ser salvo
  4ï¸âƒ£  Duas instÃ¢ncias diferentes de configuraÃ§Ã£o
  5ï¸âƒ£  Formato incorreto do token no arquivo
  6ï¸âƒ£  Cache ou buffer de arquivo nÃ£o sincronizado

INVESTIGAÃ‡ÃƒO NECESSÃRIA:
  â¤ Token vazio no arquivo de configuraÃ§Ã£o
  â¤ SUSPEITA: Script de registro nÃ£o salvou corretamente
  â¤ AÃ‡ÃƒO: Executar novo registro e verificar salvamento

ğŸ”§ CORREÃ‡ÃƒO RECOMENDADA:
curl -fsSL https://raw.githubusercontent.com/GruppenIT/SamurEye/main/docs/deployment/vlxsam04/fix-token-disconnect.sh | bash

âœ… DiagnÃ³stico concluÃ­do: Thu Sep  4 09:52:03 AM -03 2025
root@vlxsam04:~#