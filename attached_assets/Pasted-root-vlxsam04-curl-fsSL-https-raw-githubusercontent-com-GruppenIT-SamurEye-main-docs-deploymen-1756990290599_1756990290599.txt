root@vlxsam04:~# curl -fsSL https://raw.githubusercontent.com/GruppenIT/SamurEye/main/docs/deployment/vlxsam04/fix-token-disconnect.sh | bash
🛠️  CORREÇÃO: Sincronização Token Registro vs Serviço
====================================================
Data/Hora: Thu Sep  4 09:51:00 AM -03 2025

🔍 1. ANÁLISE INICIAL DO PROBLEMA
--------------------------------
✅ Arquivo de configuração encontrado
❌ Token não encontrado no arquivo
ℹ️  Serviço está parado

⏹️ 2. PARANDO SERVIÇO PARA SINCRONIZAÇÃO
----------------------------------------
ℹ️  Serviço já estava parado

🔧 3. VERIFICANDO E CORRIGINDO CONFIGURAÇÃO
------------------------------------------
📁 Fazendo backup da configuração atual...
📁 Backup criado: /var/backups/samureye-collector/.env.backup.20250904_095100
🔍 Verificando configuração atual...
❌ Token não encontrado na configuração
🧹 Limpando configuração inválida...
✅ Configuração limpa criada

📝 4. LIMPANDO LOGS COM PROBLEMA
-------------------------------
📄 Fazendo backup e limpeza do log...
📁 Backup criado: /var/backups/samureye-collector/collector.log.backup.20250904_095100
✅ Log limpo e marcado

🔄 5. RECARREGANDO CONFIGURAÇÃO DO SYSTEMD
------------------------------------------
🔄 Recarregando daemon do systemd...
✅ Daemon recarregado
🔄 Resetando falhas do serviço...
✅ Falhas resetadas

⚙️  6. PREPARANDO SERVIÇO PARA NOVO REGISTRO
-------------------------------------------
ℹ️  Serviço permanecerá parado para novo registro manual
ℹ️  Isso evita conflitos durante o processo de registro
✅ Serviço preparado para novo registro

✅ 7. VERIFICAÇÃO FINAL
----------------------
📊 Status final:
   🔴 Serviço: activating
inactive
   📁 Config: presente
   📝 Log: presente
   🔒 Permissões config: -rw------- root root

🎯 CORREÇÃO CONCLUÍDA COM SUCESSO!
=================================

📋 PRÓXIMOS PASSOS OBRIGATÓRIOS:
  1️⃣  O serviço está parado para evitar conflitos
  2️⃣  A configuração foi limpa e preparada
  3️⃣  Execute NOVO REGISTRO com o comando completo:

🔧 COMANDO DE REGISTRO:
curl -fsSL https://raw.githubusercontent.com/GruppenIT/SamurEye/main/docs/deployment/vlxsam04/register-collector.sh | bash -s -- <tenant-slug> <enrollment-token>

💡 IMPORTANTE:
  ➤ Use um NOVO token de enrollment (gere na interface)
  ➤ O token anterior pode ter expirado (15 minutos)
  ➤ O serviço será iniciado automaticamente após registro bem-sucedido

✅ Não haverá mais conflitos entre registro e serviço!

Conclusão: Thu Sep  4 09:51:00 AM -03 2025
root@vlxsam04:~# curl -fsSL https://raw.githubusercontent.com/GruppenIT/SamurEye/main/docs/deployment/vlxsam04/register-collector.sh | bash -s -- gruppen-it 2e07d1c7-f270-49a8-b2fc-7efc28522041

🔧 REGISTRO COLLECTOR SAMUREYE
==============================

[09:51:34] 🔍 Parâmetros recebidos:
   • Tenant Slug: gruppen-it
   • Token: 2e07d1c7...28522041
[09:51:34] 🔍 Verificando prerequisitos...
[09:51:35] ✅ Prerequisitos verificados
[09:51:35] 🔍 Coletando informações do sistema...
[09:51:35]    • Hostname: vlxsam04
[09:51:35]    • IP Address: 192.168.100.151
[09:51:35] 🌐 Testando conectividade com API...
[09:51:35] ✅ Conectividade OK
[09:51:35] 🔧 Registrando collector...
[09:51:35] 📤 Enviando registro para API...
[09:51:35] 📥 Processando resposta da API...
[09:51:35] 🎉 COLLECTOR REGISTRADO COM SUCESSO!

[09:51:35] 📋 DETALHES DO REGISTRO:
   • Nome do Collector: vlxsam04
   • Tenant: Gruppen it
   • Status: online
   • Hostname: vlxsam04
   • IP: 192.168.100.151

[09:51:35] ✅ Collector está online e enviando telemetria

[09:51:35] 🎯 REGISTRO CONCLUÍDO COM SUCESSO!

📋 PRÓXIMOS PASSOS:
   • O collector já está enviando telemetria automaticamente
   • Verifique o status na interface de administração
   • O collector aparecerá como 'ONLINE' na gestão de coletores

[09:51:35] ✅ Script de registro finalizado
root@vlxsam04:~# tail -f /var/log/samureye-collector/collector.log
2025-09-04 09:50:59,605 - INFO - Registrando collector: {'name': '', 'hostname': 'vlxsam04', 'ipAddress': '', 'status': 'enrolling', 'description': 'Collector agent on-premise vlxsam04'}
/usr/lib/python3/dist-packages/urllib3/connectionpool.py:1100: InsecureRequestWarning: Unverified HTTPS request is being made to host 'api.samureye.com.br'. Adding certificate verification is strongly advised. See: https://urllib3.readthedocs.io/en/latest/advanced-usage.html#tls-warnings
  warnings.warn(
2025-09-04 09:50:59,652 - ERROR - Erro no registro: 401 - {"message":"Unauthorized"}
2025-09-04 09:50:59,653 - ERROR - Falha no registro inicial
2025-09-04 09:51:00 - INFO - === CORREÇÃO APLICADA: Sincronização Token ===
2025-09-04 09:51:00 - INFO - Configuração limpa, pronto para novo registro
2025-09-04 09:51:09,867 - ERROR - Erro ao carregar configuração: [Errno 13] Permission denied: '/etc/samureye-collector/.env'
2025-09-04 09:51:20,108 - ERROR - Erro ao carregar configuração: [Errno 13] Permission denied: '/etc/samureye-collector/.env'
2025-09-04 09:51:30,353 - ERROR - Erro ao carregar configuração: [Errno 13] Permission denied: '/etc/samureye-collector/.env'
2025-09-04 09:51:40,627 - ERROR - Erro ao carregar configuração: [Errno 13] Permission denied: '/etc/samureye-collector/.env'
2025-09-04 09:51:50,868 - ERROR - Erro ao carregar configuração: [Errno 13] Permission denied: '/etc/samureye-collector/.env'
^C
root@vlxsam04:~# curl -fsSL https://raw.githubusercontent.com/GruppenIT/SamurEye/main/docs/deployment/vlxsam04/diagnose-token-disconnect.sh | bash
🔍 DIAGNÓSTICO: Desconexão Token Registro vs Serviço
===================================================
Data/Hora: Thu Sep  4 09:52:02 AM -03 2025

📊 1. STATUS DO SERVIÇO COLLECTOR
--------------------------------
❌ Serviço samureye-collector está INATIVO

📁 2. ANÁLISE DOS ARQUIVOS DE CONFIGURAÇÃO
----------------------------------------
🔍 Arquivo principal: /etc/samureye-collector/.env
✅ Arquivo encontrado
📄 Conteúdo completo:
    # SamurEye Collector Configuration
    # Configuração preparada para novo registro

    # Informações básicas do servidor
    COLLECTOR_ID=vlxsam04
    COLLECTOR_NAME=vlxsam04
    HOSTNAME=vlxsam04
    IP_ADDRESS=192.168.100.151

    # Servidor da API (não modificar)
    API_SERVER=https://api.samureye.com.br
    API_PORT=443

    # Token de registro (será preenchido durante registro)
    COLLECTOR_TOKEN=
    ENROLLMENT_TOKEN=

    # Status (será atualizado automaticamente)
    STATUS=offline

    # Logs
    LOG_LEVEL=INFO
    LOG_FILE=/var/log/samureye-collector/collector.log

    # Configurações de heartbeat
    HEARTBEAT_INTERVAL=30
    RETRY_INTERVAL=10
    MAX_RETRIES=3

🔒 Permissões do arquivo:
    -rw------- 1 root root 610 Sep  4 09:51 /etc/samureye-collector/.env

❌ COLLECTOR_TOKEN está VAZIO
❌ ENROLLMENT_TOKEN está VAZIO

🔧 3. ANÁLISE DO PROCESSO COLLECTOR
----------------------------------
❌ Nenhum processo collector encontrado

📝 4. ANÁLISE DETALHADA DOS LOGS
-------------------------------
✅ Log encontrado: /var/log/samureye-collector/collector.log
📊 Estatísticas do log:
   📏 Total de linhas: 108
   🚨 Erros 401: 13
   🔍 Token não encontrado: 12
   ✅ Registros bem-sucedidos: 0
0

📄 Últimas 15 linhas do log:
    2025-09-04 09:50:59,605 - INFO - Iniciando heartbeat collector...
    2025-09-04 09:50:59,605 - INFO - Token não encontrado, registrando collector...
    2025-09-04 09:50:59,605 - INFO - Registrando collector: {'name': '', 'hostname': 'vlxsam04', 'ipAddress': '', 'status': 'enrolling', 'description': 'Collector agent on-premise vlxsam04'}
    /usr/lib/python3/dist-packages/urllib3/connectionpool.py:1100: InsecureRequestWarning: Unverified HTTPS request is being made to host 'api.samureye.com.br'. Adding certificate verification is strongly advised. See: https://urllib3.readthedocs.io/en/latest/advanced-usage.html#tls-warnings
      warnings.warn(
    2025-09-04 09:50:59,652 - ERROR - Erro no registro: 401 - {"message":"Unauthorized"}
    2025-09-04 09:50:59,653 - ERROR - Falha no registro inicial
    2025-09-04 09:51:00 - INFO - === CORREÇÃO APLICADA: Sincronização Token ===
    2025-09-04 09:51:00 - INFO - Configuração limpa, pronto para novo registro
    2025-09-04 09:51:09,867 - ERROR - Erro ao carregar configuração: [Errno 13] Permission denied: '/etc/samureye-collector/.env'
    2025-09-04 09:51:20,108 - ERROR - Erro ao carregar configuração: [Errno 13] Permission denied: '/etc/samureye-collector/.env'
    2025-09-04 09:51:30,353 - ERROR - Erro ao carregar configuração: [Errno 13] Permission denied: '/etc/samureye-collector/.env'
    2025-09-04 09:51:40,627 - ERROR - Erro ao carregar configuração: [Errno 13] Permission denied: '/etc/samureye-collector/.env'
    2025-09-04 09:51:50,868 - ERROR - Erro ao carregar configuração: [Errno 13] Permission denied: '/etc/samureye-collector/.env'
    2025-09-04 09:52:01,136 - ERROR - Erro ao carregar configuração: [Errno 13] Permission denied: '/etc/samureye-collector/.env'

🔍 Padrão de tentativas de registro (últimas 10):
    2025-09-04 09:50:18,108 - INFO - Token não encontrado, registrando collector...
    2025-09-04 09:50:18,156 - ERROR - Erro no registro: 401 - {"message":"Unauthorized"}
    2025-09-04 09:50:28,381 - INFO - Token não encontrado, registrando collector...
    2025-09-04 09:50:28,431 - ERROR - Erro no registro: 401 - {"message":"Unauthorized"}
    2025-09-04 09:50:38,849 - INFO - Token não encontrado, registrando collector...
    2025-09-04 09:50:38,894 - ERROR - Erro no registro: 401 - {"message":"Unauthorized"}
    2025-09-04 09:50:49,131 - INFO - Token não encontrado, registrando collector...
    2025-09-04 09:50:49,184 - ERROR - Erro no registro: 401 - {"message":"Unauthorized"}
    2025-09-04 09:50:59,605 - INFO - Token não encontrado, registrando collector...
    2025-09-04 09:50:59,652 - ERROR - Erro no registro: 401 - {"message":"Unauthorized"}

🔍 5. BUSCA POR OUTROS ARQUIVOS .env
-----------------------------------
🔍 Procurando por arquivos .env relacionados ao collector:
    /etc/samureye-collector/.env

🔍 Procurando por arquivos de configuração do SamurEye:
    /etc/rsyslog.d/30-samureye-collector.conf

🌐 6. TESTE DE CONECTIVIDADE DETALHADO
------------------------------------
🔗 Testando conectividade básica:
✅ Conectividade básica: OK
🔍 Testando endpoint de heartbeat:
📊 HTTP Status heartbeat: 404
📄 Resposta heartbeat:
    {"message":"Collector not found"}
🎯 7. DIAGNÓSTICO ESPECÍFICO DO PROBLEMA
---------------------------------------
SITUAÇÃO ATUAL:
  ✅ Script register-collector.sh executado com sucesso
  ✅ Registro reportado como bem-sucedido pela API
  ❌ Serviço collector reporta 'Token não encontrado'
  ❌ Serviço gera erro 401 Unauthorized

POSSÍVEIS CAUSAS:
  1️⃣  Token salvo em local diferente do que o serviço lê
  2️⃣  Permissões incorretas impedem leitura do token
  3️⃣  Serviço iniciado antes do token ser salvo
  4️⃣  Duas instâncias diferentes de configuração
  5️⃣  Formato incorreto do token no arquivo
  6️⃣  Cache ou buffer de arquivo não sincronizado

INVESTIGAÇÃO NECESSÁRIA:
  ➤ Token vazio no arquivo de configuração
  ➤ SUSPEITA: Script de registro não salvou corretamente
  ➤ AÇÃO: Executar novo registro e verificar salvamento

🔧 CORREÇÃO RECOMENDADA:
curl -fsSL https://raw.githubusercontent.com/GruppenIT/SamurEye/main/docs/deployment/vlxsam04/fix-token-disconnect.sh | bash

✅ Diagnóstico concluído: Thu Sep  4 09:52:03 AM -03 2025
root@vlxsam04:~#