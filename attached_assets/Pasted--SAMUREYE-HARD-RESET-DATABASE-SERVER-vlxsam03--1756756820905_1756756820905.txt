üî• SAMUREYE HARD RESET - DATABASE SERVER vlxsam03
===============================================
‚ö†Ô∏è  ATEN√á√ÉO: Este script ir√°:
   ‚Ä¢ Parar todos os servi√ßos do banco de dados
   ‚Ä¢ APAGAR TODOS OS DADOS do PostgreSQL, Redis, MinIO
   ‚Ä¢ Reconfigurar pg_hba.conf e postgresql.conf
   ‚Ä¢ Resetar senhas e configura√ß√µes
   ‚Ä¢ Recriar banco e usu√°rios SamurEye
   ‚Ä¢ Reconfigurar firewall e rede

[19:58:50] WARNING: Modo n√£o-interativo detectado (curl | bash)
[19:58:50] INFO: Hard reset iniciar√° automaticamente em 5 segundos...
[19:58:55] üóëÔ∏è Iniciando hard reset do servidor de banco de dados...
[19:58:55] üîß Reparando sistema de pacotes corrompido...
[19:58:55] WARNING: Matando processos apt/dpkg em execu√ß√£o...
[19:59:00] WARNING: Removendo locks do sistema de pacotes...
[19:59:00] Executando reparos do dpkg...
[19:59:00] Tentativa 1: dpkg --configure -a
[19:59:05] Tentativa 1: apt-get -f install
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
The following package was automatically installed and is no longer required:
  libllvm17t64
Use 'apt autoremove' to remove it.
0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
[19:59:11] ‚úÖ dpkg funcionando na tentativa 1
[19:59:11] Aguardando estabiliza√ß√£o do sistema...
[19:59:21] ‚úÖ Reparo inicial do sistema de pacotes conclu√≠do
[19:59:21] üì¶ Instalando depend√™ncias b√°sicas...
[19:59:21] Tentativa 1 de atualiza√ß√£o do sistema...
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
The following package was automatically installed and is no longer required:
  libllvm17t64
Use 'apt autoremove' to remove it.
0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
Hit:1 https://packages.grafana.com/oss/deb stable InRelease
Hit:2 http://archive.ubuntu.com/ubuntu noble InRelease
Hit:3 http://security.ubuntu.com/ubuntu noble-security InRelease
Hit:4 http://apt.postgresql.org/pub/repos/apt noble-pgdg InRelease
Hit:5 http://archive.ubuntu.com/ubuntu noble-updates InRelease
Hit:6 http://archive.ubuntu.com/ubuntu noble-backports InRelease
Reading package lists... Done
[19:59:30] ‚úÖ Sistema atualizado
[19:59:30] Tentativa 1 de instala√ß√£o de depend√™ncias...
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
The following package was automatically installed and is no longer required:
  libllvm17t64
Use 'apt autoremove' to remove it.
0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
psmisc is already the newest version (23.7-1build1).
lsof is already the newest version (4.95.0-1build3).
procps is already the newest version (2:4.0.4-4ubuntu3.2).
The following package was automatically installed and is no longer required:
  libllvm17t64
Use 'apt autoremove' to remove it.
0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
[19:59:35] ‚úÖ Depend√™ncias b√°sicas instaladas
[19:59:35] ‚èπÔ∏è Parando todos os servi√ßos...
[19:59:35] üíæ Criando backup dos dados atuais...
[19:59:35] ‚úÖ Backup PostgreSQL criado
[19:59:35] üìÇ Backup salvo em: /opt/backups/samureye-reset-20250901-195935
[19:59:35] üóëÔ∏è Removendo dados existentes...
[19:59:35] ‚úÖ Dados PostgreSQL removidos
[19:59:35] ‚úÖ Configura√ß√µes PostgreSQL removidas
[19:59:35] ‚úÖ Dados Redis removidos
[19:59:35] ‚úÖ Dados MinIO removidos
[19:59:35] ‚úÖ Dados Grafana removidos
[19:59:35] üì¶ Instalando depend√™ncias adicionais...
[19:59:35] Tentativa 1 de instala√ß√£o de depend√™ncias adicionais...
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
The following package was automatically installed and is no longer required:
  libllvm17t64
Use 'apt autoremove' to remove it.
0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
wget is already the newest version (1.21.4-1ubuntu4.1).
curl is already the newest version (8.5.0-2ubuntu10.6).
gnupg2 is already the newest version (2.4.4-2ubuntu17.3).
software-properties-common is already the newest version (0.99.49.3).
apt-transport-https is already the newest version (2.8.3).
ca-certificates is already the newest version (20240203).
The following package was automatically installed and is no longer required:
  libllvm17t64
Use 'apt autoremove' to remove it.
0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
[19:59:40] ‚úÖ Depend√™ncias adicionais instaladas
[19:59:40] üêò Configurando PostgreSQL 16...
[19:59:40] üìÅ Recriando cluster PostgreSQL usando m√©todo Ubuntu...
[19:59:47] üîß Criando novo cluster PostgreSQL...
Creating new PostgreSQL cluster 16/main ...
/usr/lib/postgresql/16/bin/initdb -D /var/lib/postgresql/16/main --auth-local peer --auth-host scram-sha-256 --no-instructions
The files belonging to this database system will be owned by user "postgres".
This user must also own the server process.

The database cluster will be initialized with locale "en_US.UTF-8".
The default database encoding has accordingly been set to "UTF8".
The default text search configuration will be set to "english".

Data page checksums are disabled.

fixing permissions on existing directory /var/lib/postgresql/16/main ... ok
creating subdirectories ... ok
selecting dynamic shared memory implementation ... posix
selecting default max_connections ... 100
selecting default shared_buffers ... 128MB
selecting default time zone ... Etc/UTC
creating configuration files ... ok
running bootstrap script ... ok
performing post-bootstrap initialization ... ok
syncing data to disk ... ok
Ver Cluster Port Status Owner    Data directory              Log file
16  main    5432 online postgres /var/lib/postgresql/16/main /var/log/postgresql/postgresql-16-main.log
[19:59:56] ‚úÖ Cluster PostgreSQL recriado usando pg_createcluster
[19:59:56] üöÄ Iniciando PostgreSQL...
Synchronizing state of postgresql.service with SysV service script with /usr/lib/systemd/systemd-sysv-install.
Executing: /usr/lib/systemd/systemd-sysv-install enable postgresql
[20:00:02] ‚úÖ PostgreSQL iniciado com sucesso
[20:00:02] ‚öôÔ∏è Configurando postgresql.conf...
[20:00:02] üîê Configurando pg_hba.conf...
[20:00:02] üîÑ Reiniciando PostgreSQL para aplicar configura√ß√µes...
[20:00:09] ‚úÖ PostgreSQL configurado para SamurEye
[20:00:09] üîç Verificando conectividade PostgreSQL...
[20:00:09] ‚úÖ PostgreSQL respondendo, criando usu√°rios...
[20:00:09] üë§ Criando usu√°rio e banco SamurEye...
NOTICE:  database "samureye" does not exist, skipping
DROP DATABASE
NOTICE:  database "grafana" does not exist, skipping
DROP DATABASE
NOTICE:  role "samureye" does not exist, skipping
DROP ROLE
NOTICE:  role "grafana" does not exist, skipping
DROP ROLE
CREATE ROLE
ALTER ROLE
CREATE DATABASE
GRANT
You are now connected to database "samureye" as user "postgres".
CREATE EXTENSION
CREATE EXTENSION
GRANT
ALTER DEFAULT PRIVILEGES
ALTER DEFAULT PRIVILEGES
ALTER DEFAULT PRIVILEGES
You are now connected to database "postgres" as user "postgres".
CREATE ROLE
CREATE DATABASE
GRANT
                                                       List of databases
   Name    |  Owner   | Encoding | Locale Provider |   Collate   |    Ctype    | ICU Locale | ICU Rules |   Access privileges
-----------+----------+----------+-----------------+-------------+-------------+------------+-----------+-----------------------
 grafana   | grafana  | UTF8     | libc            | en_US.UTF-8 | en_US.UTF-8 |            |           | =Tc/grafana          +
           |          |          |                 |             |             |            |           | grafana=CTc/grafana
 postgres  | postgres | UTF8     | libc            | en_US.UTF-8 | en_US.UTF-8 |            |           |
 samureye  | samureye | UTF8     | libc            | en_US.UTF-8 | en_US.UTF-8 |            |           | =Tc/samureye         +
           |          |          |                 |             |             |            |           | samureye=CTc/samureye
 template0 | postgres | UTF8     | libc            | en_US.UTF-8 | en_US.UTF-8 |            |           | =c/postgres          +
           |          |          |                 |             |             |            |           | postgres=CTc/postgres
 template1 | postgres | UTF8     | libc            | en_US.UTF-8 | en_US.UTF-8 |            |           | =c/postgres          +
           |          |          |                 |             |             |            |           | postgres=CTc/postgres
(5 rows)

                             List of roles
 Role name |                         Attributes
-----------+------------------------------------------------------------
 grafana   |
 postgres  | Superuser, Create role, Create DB, Replication, Bypass RLS
 samureye  | Create DB

[20:00:09] üî¥ Configurando Redis...
Job for redis-server.service failed because the control process exited with error code.
See "systemctl status redis-server.service" and "journalctl -xeu redis-server.service" for details.
root@vlxsam03:~#