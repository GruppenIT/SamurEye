root@vlxsam03:~# curl -fsSL https://raw.githubusercontent.com/GruppenIT/SamurEye/refs/heads/main/docs/deployment/vlxsam03/fix-database-collectors.sh | sudo bash
ğŸ—„ï¸ vlxsam03 - CORRIGIR BANCO PARA COLLECTORS
=============================================

[14:41:14] ğŸ” Verificando PostgreSQL...
[14:41:14] âœ… PostgreSQL 16.10 ativo
[14:41:14] âœ… ConexÃ£o com banco samureye OK
[14:41:14] ğŸ“‹ Verificando estrutura das tabelas...
[14:41:14] Tabelas existentes: tenants,users,user_tenants,collectors,security_journeys,credentials
CREATE TABLE
DO
Tabelas verificadas/criadas com sucesso
[14:41:14] âœ… Estrutura de tabelas atualizada
[14:41:14] ğŸ“Š Criando Ã­ndices otimizados...
CREATE INDEX
CREATE INDEX
NOTICE:  relation "idx_collectors_status_last_seen" already exists, skipping
CREATE INDEX
NOTICE:  relation "idx_collectors_tenant_status" already exists, skipping
CREATE INDEX
CREATE INDEX
Ãndices otimizados criados
[14:41:14] âœ… Ãndices criados
[14:41:14] ğŸ§¹ Criando funÃ§Ãµes de manutenÃ§Ã£o...
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
FunÃ§Ãµes de manutenÃ§Ã£o criadas
[14:41:14] âœ… FunÃ§Ãµes de manutenÃ§Ã£o criadas
[14:41:14] â° Configurando manutenÃ§Ã£o automÃ¡tica...
[14:41:14] âœ… ManutenÃ§Ã£o automÃ¡tica configurada (a cada 5 minutos)
[14:41:14] ğŸ”„ Executando primeira manutenÃ§Ã£o...
[14:41:14] ğŸ§ª Verificando dados de collectors...
Collectors cadastrados:
          id           |   name   | status  |         last_seen          | telemetry_status
-----------------------+----------+---------+----------------------------+------------------
 vlxsam04-collector-id | vlxsam04 | offline | 2025-08-31 17:09:24.187834 | Sem telemetria
(1 row)


Telemetria recente (Ãºltimas 24h):
 total_records | collectors_with_data | oldest_record | newest_record
---------------+----------------------+---------------+---------------
             0 |                    0 |               |
(1 row)


Estrutura da tabela collector_telemetry:
                          Table "public.collector_telemetry"
     Column      |           Type           | Collation | Nullable |      Default
-----------------+--------------------------+-----------+----------+-------------------
 id              | uuid                     |           | not null | gen_random_uuid()
 collector_id    | character varying(255)   |           | not null |
 timestamp       | timestamp with time zone |           |          | CURRENT_TIMESTAMP
 cpu_usage       | numeric(5,2)             |           |          |
 memory_usage    | numeric(5,2)             |           |          |
 disk_usage      | numeric(5,2)             |           |          |
 network_io      | jsonb                    |           |          |
 process_count   | integer                  |           |          |
 additional_data | jsonb                    |           |          |
 created_at      | timestamp with time zone |           |          | CURRENT_TIMESTAMP
Indexes:
    "collector_telemetry_pkey" PRIMARY KEY, btree (id)
    "idx_collector_telemetry_collector_timestamp" btree (collector_id, "timestamp" DESC)
    "idx_collector_telemetry_timestamp" btree ("timestamp" DESC)


[14:41:15] ğŸ¯ BANCO CORRIGIDO E OTIMIZADO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“Š TABELAS CRIADAS/VERIFICADAS:
   âœ“ collector_telemetry - Dados de telemetria
   âœ“ collectors - Atualizada com campos necessÃ¡rios

ğŸ”§ FUNCIONALIDADES:
   âœ“ DetecÃ§Ã£o automÃ¡tica offline (5min timeout)
   âœ“ Limpeza automÃ¡tica telemetria (7 dias)
   âœ“ AtualizaÃ§Ã£o latest_telemetry automÃ¡tica
   âœ“ Ãndices otimizados para performance

â° MANUTENÃ‡ÃƒO AUTOMÃTICA:
   âœ“ Executa a cada 5 minutos via cron
   âœ“ Log: /var/log/samureye-db-maintenance.log

ğŸ“ MONITORAMENTO:
   â€¢ Logs: tail -f /var/log/samureye-db-maintenance.log
   â€¢ Status: sudo -u postgres psql samureye -c 'SELECT * FROM collectors;'

ğŸ’¡ PRÃ“XIMO PASSO:
   Continuar com vlxsam02 (aplicaÃ§Ã£o)
root@vlxsam03:~#