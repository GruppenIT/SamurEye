root@vlxsam03:~# curl -fsSL https://raw.githubusercontent.com/GruppenIT/SamurEye/refs/heads/main/docs/deployment/vlxsam03/fix-database-collectors.sh | sudo bash
🗄️ vlxsam03 - CORRIGIR BANCO PARA COLLECTORS
=============================================

[14:41:14] 🔍 Verificando PostgreSQL...
[14:41:14] ✅ PostgreSQL 16.10 ativo
[14:41:14] ✅ Conexão com banco samureye OK
[14:41:14] 📋 Verificando estrutura das tabelas...
[14:41:14] Tabelas existentes: tenants,users,user_tenants,collectors,security_journeys,credentials
CREATE TABLE
DO
Tabelas verificadas/criadas com sucesso
[14:41:14] ✅ Estrutura de tabelas atualizada
[14:41:14] 📊 Criando índices otimizados...
CREATE INDEX
CREATE INDEX
NOTICE:  relation "idx_collectors_status_last_seen" already exists, skipping
CREATE INDEX
NOTICE:  relation "idx_collectors_tenant_status" already exists, skipping
CREATE INDEX
CREATE INDEX
Índices otimizados criados
[14:41:14] ✅ Índices criados
[14:41:14] 🧹 Criando funções de manutenção...
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
Funções de manutenção criadas
[14:41:14] ✅ Funções de manutenção criadas
[14:41:14] ⏰ Configurando manutenção automática...
[14:41:14] ✅ Manutenção automática configurada (a cada 5 minutos)
[14:41:14] 🔄 Executando primeira manutenção...
[14:41:14] 🧪 Verificando dados de collectors...
Collectors cadastrados:
          id           |   name   | status  |         last_seen          | telemetry_status
-----------------------+----------+---------+----------------------------+------------------
 vlxsam04-collector-id | vlxsam04 | offline | 2025-08-31 17:09:24.187834 | Sem telemetria
(1 row)


Telemetria recente (últimas 24h):
 total_records | collectors_with_data | oldest_record | newest_record
---------------+----------------------+---------------+---------------
             0 |                    0 |               |
(1 row)


Estrutura da tabela collector_telemetry:
                          Table "public.collector_telemetry"
     Column      |           Type           | Collation | Nullable |      Default
-----------------+--------------------------+-----------+----------+-------------------
 id              | uuid                     |           | not null | gen_random_uuid()
 collector_id    | character varying(255)   |           | not null |
 timestamp       | timestamp with time zone |           |          | CURRENT_TIMESTAMP
 cpu_usage       | numeric(5,2)             |           |          |
 memory_usage    | numeric(5,2)             |           |          |
 disk_usage      | numeric(5,2)             |           |          |
 network_io      | jsonb                    |           |          |
 process_count   | integer                  |           |          |
 additional_data | jsonb                    |           |          |
 created_at      | timestamp with time zone |           |          | CURRENT_TIMESTAMP
Indexes:
    "collector_telemetry_pkey" PRIMARY KEY, btree (id)
    "idx_collector_telemetry_collector_timestamp" btree (collector_id, "timestamp" DESC)
    "idx_collector_telemetry_timestamp" btree ("timestamp" DESC)


[14:41:15] 🎯 BANCO CORRIGIDO E OTIMIZADO
════════════════════════════════════════════════

📊 TABELAS CRIADAS/VERIFICADAS:
   ✓ collector_telemetry - Dados de telemetria
   ✓ collectors - Atualizada com campos necessários

🔧 FUNCIONALIDADES:
   ✓ Detecção automática offline (5min timeout)
   ✓ Limpeza automática telemetria (7 dias)
   ✓ Atualização latest_telemetry automática
   ✓ Índices otimizados para performance

⏰ MANUTENÇÃO AUTOMÁTICA:
   ✓ Executa a cada 5 minutos via cron
   ✓ Log: /var/log/samureye-db-maintenance.log

📝 MONITORAMENTO:
   • Logs: tail -f /var/log/samureye-db-maintenance.log
   • Status: sudo -u postgres psql samureye -c 'SELECT * FROM collectors;'

💡 PRÓXIMO PASSO:
   Continuar com vlxsam02 (aplicação)
root@vlxsam03:~#