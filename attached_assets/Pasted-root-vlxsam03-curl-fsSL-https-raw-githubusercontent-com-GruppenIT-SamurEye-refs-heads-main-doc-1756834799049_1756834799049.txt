root@vlxsam03:~# curl -fsSL https://raw.githubusercontent.com/GruppenIT/SamurEye/refs/heads/main/docs/deployment/vlxsam03/install-hard-reset.sh | bash

üî• SAMUREYE HARD RESET - DATABASE SERVER vlxsam03
===============================================
‚ö†Ô∏è  ATEN√á√ÉO: Este script ir√°:
   ‚Ä¢ Parar todos os servi√ßos do banco de dados
   ‚Ä¢ APAGAR TODOS OS DADOS do PostgreSQL, Redis, MinIO
   ‚Ä¢ Reconfigurar pg_hba.conf e postgresql.conf
   ‚Ä¢ Resetar senhas e configura√ß√µes
   ‚Ä¢ Recriar banco e usu√°rios SamurEye
   ‚Ä¢ Reconfigurar firewall e rede

[17:30:21] WARNING: Modo n√£o-interativo detectado (curl | bash)
[17:30:21] INFO: Hard reset iniciar√° automaticamente em 5 segundos...
[17:30:26] üóëÔ∏è Iniciando hard reset do servidor de banco de dados...
[17:30:26] üîß Reparando sistema de pacotes corrompido...
[17:30:26] WARNING: Matando processos apt/dpkg em execu√ß√£o...
[17:30:31] WARNING: Removendo locks do sistema de pacotes...
[17:30:31] Executando reparos do dpkg...
[17:30:31] Tentativa 1: dpkg --configure -a
[17:30:36] Tentativa 1: apt-get -f install
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
The following package was automatically installed and is no longer required:
  libllvm17t64
Use 'apt autoremove' to remove it.
0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
[17:30:42] ‚úÖ dpkg funcionando na tentativa 1
[17:30:42] Aguardando estabiliza√ß√£o do sistema...
[17:30:52] ‚úÖ Reparo inicial do sistema de pacotes conclu√≠do
[17:30:52] üì¶ Instalando depend√™ncias b√°sicas...
[17:30:52] Tentativa 1 de atualiza√ß√£o do sistema...
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
The following package was automatically installed and is no longer required:
  libllvm17t64
Use 'apt autoremove' to remove it.
0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
Hit:1 https://packages.grafana.com/oss/deb stable InRelease
Hit:2 http://security.ubuntu.com/ubuntu noble-security InRelease
Hit:3 http://archive.ubuntu.com/ubuntu noble InRelease
Hit:4 http://apt.postgresql.org/pub/repos/apt noble-pgdg InRelease
Hit:5 http://archive.ubuntu.com/ubuntu noble-updates InRelease
Hit:6 http://archive.ubuntu.com/ubuntu noble-backports InRelease
Reading package lists... Done
[17:31:01] ‚úÖ Sistema atualizado
[17:31:01] Tentativa 1 de instala√ß√£o de depend√™ncias...
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
The following package was automatically installed and is no longer required:
  libllvm17t64
Use 'apt autoremove' to remove it.
0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
psmisc is already the newest version (23.7-1build1).
lsof is already the newest version (4.95.0-1build3).
procps is already the newest version (2:4.0.4-4ubuntu3.2).
The following package was automatically installed and is no longer required:
  libllvm17t64
Use 'apt autoremove' to remove it.
0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
[17:31:06] ‚úÖ Depend√™ncias b√°sicas instaladas
[17:31:06] ‚èπÔ∏è Parando todos os servi√ßos...
[17:31:06] ‚úÖ postgresql parado
[17:31:06] ‚úÖ redis-server parado
[17:31:06] ‚úÖ minio parado
[17:31:06] ‚úÖ grafana-server parado
[17:31:06] üíæ Criando backup dos dados atuais...
[17:31:08] ‚úÖ Backup PostgreSQL criado
[17:31:08] ‚úÖ Backup Redis criado
[17:31:08] ‚úÖ Backup MinIO criado
[17:31:08] üìÇ Backup salvo em: /opt/backups/samureye-reset-20250902-173106
[17:31:08] üóëÔ∏è Removendo dados existentes...
[17:31:08] ‚úÖ Dados PostgreSQL removidos
[17:31:08] ‚úÖ Configura√ß√µes PostgreSQL removidas
[17:31:08] ‚úÖ Dados Redis removidos
[17:31:08] ‚úÖ Dados MinIO removidos
[17:31:08] ‚úÖ Dados Grafana removidos
[17:31:08] üì¶ Instalando depend√™ncias adicionais...
[17:31:08] Tentativa 1 de instala√ß√£o de depend√™ncias adicionais...
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
The following package was automatically installed and is no longer required:
  libllvm17t64
Use 'apt autoremove' to remove it.
0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
wget is already the newest version (1.21.4-1ubuntu4.1).
curl is already the newest version (8.5.0-2ubuntu10.6).
gnupg2 is already the newest version (2.4.4-2ubuntu17.3).
software-properties-common is already the newest version (0.99.49.3).
apt-transport-https is already the newest version (2.8.3).
ca-certificates is already the newest version (20240203).
The following package was automatically installed and is no longer required:
  libllvm17t64
Use 'apt autoremove' to remove it.
0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
[17:31:13] ‚úÖ Depend√™ncias adicionais instaladas
[17:31:13] üêò Configurando PostgreSQL 16...
[17:31:13] üìÅ Recriando cluster PostgreSQL usando m√©todo Ubuntu...
[17:31:20] üîß Criando novo cluster PostgreSQL...
Creating new PostgreSQL cluster 16/main ...
/usr/lib/postgresql/16/bin/initdb -D /var/lib/postgresql/16/main --auth-local peer --auth-host scram-sha-256 --no-instructions
The files belonging to this database system will be owned by user "postgres".
This user must also own the server process.

The database cluster will be initialized with locale "en_US.UTF-8".
The default database encoding has accordingly been set to "UTF8".
The default text search configuration will be set to "english".

Data page checksums are disabled.

fixing permissions on existing directory /var/lib/postgresql/16/main ... ok
creating subdirectories ... ok
selecting dynamic shared memory implementation ... posix
selecting default max_connections ... 100
selecting default shared_buffers ... 128MB
selecting default time zone ... Etc/UTC
creating configuration files ... ok
running bootstrap script ... ok
performing post-bootstrap initialization ... ok
syncing data to disk ... ok
Ver Cluster Port Status Owner    Data directory              Log file
16  main    5432 online postgres /var/lib/postgresql/16/main /var/log/postgresql/postgresql-16-main.log
[17:31:29] ‚úÖ Cluster PostgreSQL recriado usando pg_createcluster
[17:31:29] üöÄ Iniciando PostgreSQL...
Synchronizing state of postgresql.service with SysV service script with /usr/lib/systemd/systemd-sysv-install.
Executing: /usr/lib/systemd/systemd-sysv-install enable postgresql
[17:31:35] ‚úÖ PostgreSQL iniciado com sucesso
[17:31:35] ‚öôÔ∏è Configurando postgresql.conf...
[17:31:35] üîê Configurando pg_hba.conf...
[17:31:35] üîÑ Reiniciando PostgreSQL para aplicar configura√ß√µes...
[17:31:42] ‚úÖ PostgreSQL configurado para SamurEye
[17:31:42] üîç Verificando conectividade PostgreSQL...
[17:31:42] ‚úÖ PostgreSQL respondendo, criando usu√°rios...
[17:31:42] üë§ Criando usu√°rio e banco SamurEye...
NOTICE:  database "samureye" does not exist, skipping
DROP DATABASE
NOTICE:  database "grafana" does not exist, skipping
DROP DATABASE
NOTICE:  role "samureye_user" does not exist, skipping
DROP ROLE
NOTICE:  role "samureye" does not exist, skipping
DROP ROLE
NOTICE:  role "grafana" does not exist, skipping
DROP ROLE
CREATE ROLE
ALTER ROLE
ALTER ROLE
CREATE ROLE
ALTER ROLE
ALTER ROLE
CREATE DATABASE
GRANT
GRANT
You are now connected to database "samureye" as user "postgres".
CREATE EXTENSION
CREATE EXTENSION
GRANT
GRANT
ALTER DEFAULT PRIVILEGES
ALTER DEFAULT PRIVILEGES
ALTER DEFAULT PRIVILEGES
ALTER DEFAULT PRIVILEGES
ALTER DEFAULT PRIVILEGES
ALTER DEFAULT PRIVILEGES
You are now connected to database "postgres" as user "postgres".
CREATE ROLE
CREATE DATABASE
GRANT
                                                               List of databases
   Name    |     Owner     | Encoding | Locale Provider |   Collate   |    Ctype    | ICU Locale | ICU Rules |        Access privileges
-----------+---------------+----------+-----------------+-------------+-------------+------------+-----------+---------------------------------
 grafana   | grafana       | UTF8     | libc            | en_US.UTF-8 | en_US.UTF-8 |            |           | =Tc/grafana                    +
           |               |          |                 |             |             |            |           | grafana=CTc/grafana
 postgres  | postgres      | UTF8     | libc            | en_US.UTF-8 | en_US.UTF-8 |            |           |
 samureye  | samureye_user | UTF8     | libc            | en_US.UTF-8 | en_US.UTF-8 |            |           | =Tc/samureye_user              +
           |               |          |                 |             |             |            |           | samureye_user=CTc/samureye_user+
           |               |          |                 |             |             |            |           | samureye=CTc/samureye_user
 template0 | postgres      | UTF8     | libc            | en_US.UTF-8 | en_US.UTF-8 |            |           | =c/postgres                    +
           |               |          |                 |             |             |            |           | postgres=CTc/postgres
 template1 | postgres      | UTF8     | libc            | en_US.UTF-8 | en_US.UTF-8 |            |           | =c/postgres                    +
           |               |          |                 |             |             |            |           | postgres=CTc/postgres
(5 rows)

                               List of roles
   Role name   |                         Attributes
---------------+------------------------------------------------------------
 grafana       |
 postgres      | Superuser, Create role, Create DB, Replication, Bypass RLS
 samureye      | Superuser, Create DB
 samureye_user | Superuser, Create DB

[17:31:42] üî¥ Configurando Redis...
[17:31:42] üöÄ Iniciando Redis...
Synchronizing state of redis-server.service with SysV service script with /usr/lib/systemd/systemd-sysv-install.
Executing: /usr/lib/systemd/systemd-sysv-install enable redis-server
[17:31:46] ‚úÖ Redis iniciado com sucesso
[17:31:46] ‚úÖ Redis respondendo corretamente
[17:31:46] üì¶ Configurando MinIO...
[17:31:47] üìä Configurando Grafana...
Synchronizing state of grafana-server.service with SysV service script with /usr/lib/systemd/systemd-sysv-install.
Executing: /usr/lib/systemd/systemd-sysv-install enable grafana-server
[17:31:48] üî• Configurando firewall UFW...
Backing up 'user.rules' to '/etc/ufw/user.rules.20250902_173149'
Backing up 'before.rules' to '/etc/ufw/before.rules.20250902_173149'
Backing up 'after.rules' to '/etc/ufw/after.rules.20250902_173149'
Backing up 'user6.rules' to '/etc/ufw/user6.rules.20250902_173149'
Backing up 'before6.rules' to '/etc/ufw/before6.rules.20250902_173149'
Backing up 'after6.rules' to '/etc/ufw/after6.rules.20250902_173149'

Default incoming policy changed to 'deny'
(be sure to update your rules accordingly)
Default outgoing policy changed to 'allow'
(be sure to update your rules accordingly)
Rules updated
Rules updated (v6)
Rules updated
Rules updated
Rules updated
Rules updated
Rules updated
Firewall is active and enabled on system startup
[17:31:50] üß™ Criando script de teste...
[17:31:50] ‚úÖ Executando testes finais...
[17:32:00] ‚úÖ PostgreSQL funcionando
[17:32:00] üîç Testando conectividade remota do vlxsam02...
[17:32:00] ‚úÖ Conectividade remota funcionando
[17:32:00] ‚úÖ Redis funcionando
[17:32:00] ‚úÖ MinIO funcionando
[17:32:00] ‚úÖ Grafana funcionando

üéâ HARD RESET CONCLU√çDO COM SUCESSO!
=====================================

üìä SERVI√áOS CONFIGURADOS:
‚Ä¢ PostgreSQL 16: samureye_user/samureye_secure_2024 @ :5432
‚Ä¢ Redis: redis123 @ :6379
‚Ä¢ MinIO: minio/minio123 @ :9000
‚Ä¢ Grafana: admin/grafana123 @ :3000

üîß COMANDOS √öTEIS:
‚Ä¢ Testar tudo: /usr/local/bin/test-samureye-db.sh
‚Ä¢ Status: systemctl status postgresql redis-server minio grafana-server
‚Ä¢ Logs PostgreSQL: tail -f /var/log/postgresql/postgresql-*.log
‚Ä¢ Conectar DB: PGPASSWORD=samureye_secure_2024 psql -h localhost -U samureye_user -d samureye
‚Ä¢ Testar remoto: PGPASSWORD=samureye_secure_2024 psql -h 172.24.1.153 -U samureye_user -d samureye

üìÇ Backup dos dados antigos: /opt/backups/samureye-reset-20250902-173106

‚ö†Ô∏è PR√ìXIMOS PASSOS:
1. Execute o reset no vlxsam02 (Application)
2. Execute o reset no vlxsam01 (Gateway)
3. Execute o reset no vlxsam04 (Collector)

[17:32:00] Database server vlxsam03 pronto para uso!
root@vlxsam03:~#